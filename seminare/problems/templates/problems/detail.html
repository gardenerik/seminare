{% extends "base.html" %}
{% load markdownify %}
{% block head %}
    <script>
        const submits = [];
        const setFiles = () => {
            const b = new DataTransfer();
            for (const file of submits) b.items.add(file);
            document.getElementById('filepicker').files = b.files;
        };
        const onSubmitDelete = (filename) => {
            for (let i = 0; i < submits.length; i++) {
                if (submits[i].name === filename) {
                    submits.splice(i, 1);
                    if (submits.length === 0) {
                        document.getElementById('form').classList.add('hidden');
                    }
                    setFiles();
                    return;
                }
            }
        };
        const onFileSubmit = () => {
            const filepicker = document.getElementById('filepicker');
            for (const file of filepicker.files) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    filepicker.insertAdjacentHTML("beforebegin", `
                        <div class="file px-2 py-1 text-sm">
                            <img src="${reader.result}">
                            <div class="file__name">
                                ${file.name}
                                <iconify-icon class="icon" icon="mdi:close" onclick="document.getElementById('form').removeChild(this.parentElement.parentElement); onSubmitDelete('${file.name}')"></iconify-icon>
                            </div>
                        </div>
                        `);
                };
            }
            submits.push(...filepicker.files);
            setFiles();
            document.getElementById('form').classList.remove('hidden');
        };
    </script>
{% endblock %}

{% block title %}{{ problem.name }} {{ block.super }}{% endblock %}

{% block root_body %}
    <div class="flex flex-col md:flex-row" data-controller="toggle" data-toggle-toggle-class="hidden">
        <div class="shrink-0 w-full md:w-80 bg-white z-10 hidden md:block border-b md:border-b-0 absolute md:relative md:border-r" data-toggle-target="toggle">
            <div class="py-3 px-4 font-bold border-b text-lg flex items-center justify-between">
                <span>1. kolo, 3. časť, 12. ročník KMS</span>

                <div class="cursor-pointer md:hidden flex p-3 -m-3 rounded-full hover:bg-gray-100 items-center justify-center" data-action="click->toggle#click">
                    <iconify-icon icon="mdi:close"></iconify-icon>
                </div>
            </div>
            {% for side_problem in problems %}
                <a class="block px-4 py-3 hover:bg-gray-100 {% if side_problem.id == problem.id %}font-semibold bg-gray-100{% endif %}" href="{% url "problem_detail" side_problem.problem_set_id side_problem.number %}">
                    {{ side_problem.number }}. {{ side_problem.name }}
                </a>
            {% endfor %}
        </div>

        <div class="flex-1 p-4 md:py-8">
            <div class="mx-auto max-w-prose">
                <a href="#" class="mb-2 flex justify-end items-center text-blue-700 hover:text-blue-900 md:hidden"
                   data-action="click->toggle#click">
                    <iconify-icon icon="mdi:menu" class="mr-2"></iconify-icon>
                    Zoznam úloh
                </a>

                <div class="prose">
                    {{ statement.text|markdownify }}
                </div>
            </div>
        </div>

        <div class="shrink-0 w-full p-4 md:border-l md:w-80">
            {% if problem.category == 0 %}
                <div class="flex flex--items-center">
                    <iconify-icon icon="mdi:warning" style="margin-right: .5rem; flex-shrink: 0"></iconify-icon>
                    Za túto úlohu nedostávaš v svojej kategórií body.
                </div>
            {% endif %}

            <div class="submit-form">
                <div class="submit-form__header">Odovzdať popis</div>

                <div class="submit-form__dropzone" onclick="document.getElementById('filepicker').click()">
                    <iconify-icon icon="mdi:upload" width="none" class="icon icon--large"></iconify-icon>
                    <p>Vyber alebo presuň tvoje riešenie sem</p>
                </div>

                <form method="POST" enctype="multipart/form-data" action="{% url "file_submit" problem.id %}" id="form"
                      class="hidden"
                      style="margin-top: .5rem">
                    {% csrf_token %}
                    <input type="file" name="files" multiple accept="image/jpeg, image/png" class="hidden"
                           id="filepicker"
                           onchange="onFileSubmit()">
                    <button class="button button--primary" style="margin-top: .5rem">Odovzdať</button>
                </form>

                <div class="submit-form__subheader">Odovzdané riešenia</div>

                <div class="submit-list">
                    {% for submit in submits.file %}
                        <a href="{% url "file_submit_detail" submit.id %}" class="submit-list__item {% if submit.score is not None %}submit-list__item--graded{% endif %}">
                            <iconify-icon icon="mdi:file-text"></iconify-icon>
                            <span>{{ submit.created_at|date:"d.m.Y" }} {{ submit.created_at|time:"H:i" }}</span>

                            <span class="submit-list__item_score">
                                {% if submit.score is not None %}
                                    {{ submit.score|floatformat:"g" }} b
                                {% else %}
                                    (neopravené)
                                {% endif %}
                            </span>
                        </a>
                    {% empty %}
                        <div class="submit-list__empty">Zatiaľ si nič neodovzdal/a.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
